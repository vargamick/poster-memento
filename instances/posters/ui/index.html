<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Poster Memento - Browser</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <header>
      <h1>Poster Memento</h1>
      <p class="subtitle">Browse and search your poster collection</p>
      <div class="search-bar">
        <input type="text" id="search-input" placeholder="Search posters by title, artist, venue...">
        <select id="search-strategy">
          <option value="hybrid">Hybrid Search</option>
          <option value="graph">Graph Search</option>
          <option value="vector">Semantic Search</option>
        </select>
        <button id="search-btn">Search</button>
        <button id="clear-btn" class="secondary">Clear</button>
      </div>
    </header>

    <!-- Tab Navigation -->
    <nav class="tabs">
      <button class="tab-btn active" data-tab="browse">Browse Collection</button>
      <button class="tab-btn" data-tab="processing">Process Images</button>
      <button class="tab-btn" data-tab="qa-validation">QA Validation</button>
    </nav>

    <main>
      <!-- Browse Tab (existing content) -->
      <div id="browse-tab" class="tab-content">
      <div class="controls">
        <div class="left-controls">
          <select id="limit-select">
            <option value="10">10 per page</option>
            <option value="25">25 per page</option>
            <option value="50">50 per page</option>
          </select>
          <span class="total-info">Total: <span id="total-count">0</span> posters</span>
        </div>
        <div class="pagination">
          <button id="prev-btn" disabled>Previous</button>
          <span id="page-info">Page 1</span>
          <button id="next-btn">Next</button>
        </div>
      </div>

      <div id="loading" class="loading hidden">
        <div class="spinner"></div>
        <p>Loading posters...</p>
      </div>

      <div id="error" class="error hidden">
        <p id="error-message"></p>
        <button id="retry-btn">Retry</button>
      </div>

      <div class="table-container">
        <table id="poster-table" class="poster-table">
          <thead>
            <tr>
              <th class="th-thumbnail">Image</th>
              <th class="th-name sortable" data-sort="name">Name <span class="sort-icon"></span></th>
              <th class="th-type sortable" data-sort="poster_type">Type <span class="sort-icon"></span></th>
              <th class="th-artists">People</th>
              <th class="th-venue sortable" data-sort="venue_name">Venue <span class="sort-icon"></span></th>
              <th class="th-date sortable" data-sort="event_date">Date <span class="sort-icon"></span></th>
              <th class="th-added sortable active desc" data-sort="createdAt">Added <span class="sort-icon"></span></th>
            </tr>
          </thead>
          <tbody id="poster-tbody">
            <!-- Poster rows rendered here -->
          </tbody>
        </table>
      </div>

      <!-- Empty State (shown when no posters) -->
      <div id="empty-state" class="empty-state hidden">
        <h3>No posters found</h3>
        <p>Try a different search term or add some posters to get started.</p>
      </div>

      <!-- Detail Modal -->
      <div id="poster-modal" class="modal hidden">
        <div class="modal-content">
          <button class="modal-close" id="modal-close">&times;</button>
          <div id="poster-detail">
            <!-- Single poster detail view -->
          </div>
        </div>
      </div>

      <!-- Image Lightbox Modal -->
      <div id="lightbox-modal" class="lightbox hidden">
        <div class="lightbox-backdrop"></div>
        <div class="lightbox-content">
          <button class="lightbox-close" id="lightbox-close">&times;</button>
          <img id="lightbox-image" src="" alt="">
          <div id="lightbox-caption" class="lightbox-caption"></div>
        </div>
      </div>
      </div><!-- End Browse Tab -->

      <!-- Processing Tab -->
      <div id="processing-tab" class="tab-content hidden">
        <!-- Source Folder Section -->
        <section class="processing-section source-section">
          <h2><span class="icon">üìÅ</span> Source Images</h2>
          <div class="source-controls">
            <input type="text" id="source-path" value="./SourceImages" placeholder="Path to source images" readonly>
            <button type="button" id="scan-btn" class="preview-btn">Scan Folder</button>
            <button type="button" id="refresh-btn" class="secondary-btn">Refresh</button>
          </div>
          <div class="source-stats">
            <span>Total: <strong id="total-images">0</strong> images</span>
            <span>Unprocessed: <strong id="unprocessed-count">--</strong></span>
          </div>
        </section>

        <!-- Configuration Section -->
        <section class="processing-section config-section">
          <h2><span class="icon">‚öôÔ∏è</span> Processing Configuration</h2>
          <div class="config-grid">
            <label>
              Vision Model
              <select id="model-select">
                <option value="">Loading models...</option>
              </select>
            </label>
            <label>
              Batch Size
              <select id="batch-size-select">
                <option value="1">1 (Test single)</option>
                <option value="5" selected>5</option>
                <option value="10">10</option>
                <option value="25">25</option>
              </select>
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="skip-existing" checked>
              Skip already processed
            </label>
            <label class="checkbox-label">
              <input type="checkbox" id="store-images" checked>
              Store images in MinIO
            </label>
          </div>
        </section>

        <!-- File Browser Section -->
        <section class="processing-section file-browser-section">
          <h2><span class="icon">üñºÔ∏è</span> Images to Process</h2>
          <div class="file-controls">
            <button type="button" id="select-all-btn">Select All</button>
            <button type="button" id="deselect-all-btn">Deselect All</button>
            <span class="selection-info">Selected: <strong id="selected-count">0</strong></span>
          </div>
          <div class="file-list" id="file-list">
            <div class="file-list-empty">
              <p>No images loaded</p>
              <p>Click "Scan Folder" to discover images</p>
            </div>
          </div>
          <div class="file-pagination">
            <button type="button" id="files-prev-btn" disabled>Previous</button>
            <span id="files-page-info">Page 0 of 0</span>
            <button type="button" id="files-next-btn" disabled>Next</button>
          </div>
        </section>

        <!-- Actions Section -->
        <section class="processing-section actions-section">
          <button type="button" id="preview-btn" class="preview-btn" disabled>Preview Selected</button>
          <button type="button" id="process-btn" class="process-btn" disabled>Process Selected</button>
          <button type="button" id="process-all-btn" class="secondary-btn" disabled>Process All Unprocessed</button>
        </section>

        <!-- Progress Section (shown during processing) -->
        <section id="progress-section" class="processing-section progress-section hidden">
          <h2><span class="icon">‚è≥</span> Processing Progress</h2>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
          <div class="progress-stats">
            <span>Progress: <strong id="progress-percent">0%</strong></span>
            <span>Processed: <strong id="progress-processed">0</strong></span>
            <span class="succeeded">Succeeded: <strong id="progress-succeeded">0</strong></span>
            <span class="failed">Failed: <strong id="progress-failed">0</strong></span>
          </div>
          <div class="progress-log" id="progress-log">
            <!-- Processing log entries will appear here -->
          </div>
          <div class="progress-actions">
            <button type="button" id="cancel-processing-btn" class="secondary-btn">Cancel</button>
          </div>
        </section>
      </div><!-- End Processing Tab -->

      <!-- QA Validation Tab -->
      <div id="qa-validation-tab" class="tab-content hidden">
        <!-- Validation Overview Section -->
        <section class="processing-section qa-overview-section">
          <h2><span class="icon">üîç</span> QA Validation</h2>
          <p class="section-description">Validate extracted poster data against external sources (MusicBrainz, Discogs, TMDB)</p>
          <div class="qa-status-cards">
            <div class="qa-status-card">
              <span class="qa-status-value" id="qa-total-posters">--</span>
              <span class="qa-status-label">Total Posters</span>
            </div>
            <div class="qa-status-card validated">
              <span class="qa-status-value" id="qa-validated-count">--</span>
              <span class="qa-status-label">Validated</span>
            </div>
            <div class="qa-status-card warning">
              <span class="qa-status-value" id="qa-warning-count">--</span>
              <span class="qa-status-label">Warnings</span>
            </div>
            <div class="qa-status-card error">
              <span class="qa-status-value" id="qa-mismatch-count">--</span>
              <span class="qa-status-label">Mismatches</span>
            </div>
          </div>
        </section>

        <!-- Validation Configuration Section -->
        <section class="processing-section qa-config-section">
          <h2><span class="icon">‚öôÔ∏è</span> Validation Settings</h2>
          <div class="config-grid">
            <label>
              Poster Types
              <select id="qa-poster-types" multiple size="5">
                <option value="concert" selected>Concert</option>
                <option value="festival" selected>Festival</option>
                <option value="film" selected>Film</option>
                <option value="release" selected>Release</option>
                <option value="unknown" selected>Unknown (for type inference)</option>
                <option value="comedy">Comedy</option>
                <option value="theater">Theater</option>
                <option value="promo">Promo</option>
              </select>
            </label>
            <label>
              Validators
              <select id="qa-validators" multiple size="5">
                <option value="artist" selected>Artist (MusicBrainz/Discogs)</option>
                <option value="venue" selected>Venue (Location check)</option>
                <option value="date" selected>Date (Format validation)</option>
                <option value="release" selected>Release (Album/Film)</option>
                <option value="poster_type" selected>Poster Type (Type inference)</option>
              </select>
            </label>
            <label>
              Batch Size
              <select id="qa-batch-size">
                <option value="5">5 posters</option>
                <option value="10" selected>10 posters</option>
                <option value="25">25 posters</option>
                <option value="50">50 posters</option>
              </select>
            </label>
            <label>
              Min Confidence
              <select id="qa-confidence-threshold">
                <option value="0.5">50%</option>
                <option value="0.7" selected>70%</option>
                <option value="0.8">80%</option>
                <option value="0.9">90%</option>
              </select>
            </label>
          </div>
        </section>

        <!-- Validation Actions Section -->
        <section class="processing-section qa-actions-section">
          <div class="qa-action-buttons">
            <button type="button" id="qa-start-btn" class="process-btn">Start Validation</button>
            <button type="button" id="qa-check-health-btn" class="secondary-btn">Check API Health</button>
          </div>
          <div id="qa-api-health" class="qa-api-health hidden">
            <span class="health-item" id="health-musicbrainz">MusicBrainz: <span class="health-status">--</span></span>
            <span class="health-item" id="health-discogs">Discogs: <span class="health-status">--</span></span>
            <span class="health-item" id="health-tmdb">TMDB: <span class="health-status">--</span></span>
          </div>
        </section>

        <!-- Validation Progress Section (shown during validation) -->
        <section id="qa-progress-section" class="processing-section progress-section hidden">
          <h2><span class="icon">‚è≥</span> Validation Progress</h2>
          <div class="progress-bar">
            <div class="progress-fill" id="qa-progress-fill"></div>
          </div>
          <div class="progress-stats">
            <span>Progress: <strong id="qa-progress-percent">0%</strong></span>
            <span>Phase: <strong id="qa-progress-phase">Starting...</strong></span>
          </div>
          <div class="progress-log" id="qa-progress-log">
            <!-- Validation log entries will appear here -->
          </div>
          <div class="progress-actions">
            <button type="button" id="qa-cancel-btn" class="secondary-btn">Cancel Validation</button>
          </div>
        </section>

        <!-- Validation Results Section -->
        <section id="qa-results-section" class="processing-section qa-results-section hidden">
          <div class="qa-results-header">
            <h2><span class="icon">üìä</span> Validation Results</h2>
            <div class="qa-results-summary">
              <span>Overall Score: <strong id="qa-overall-score">--</strong></span>
            </div>
          </div>

          <!-- Filter Controls -->
          <div class="qa-filter-controls">
            <button type="button" class="qa-filter-btn active" data-filter="all">All</button>
            <button type="button" class="qa-filter-btn" data-filter="mismatch">Mismatches</button>
            <button type="button" class="qa-filter-btn" data-filter="warning">Warnings</button>
            <button type="button" class="qa-filter-btn" data-filter="validated">Validated</button>
          </div>

          <!-- Bulk Actions -->
          <div class="qa-bulk-actions">
            <button type="button" id="qa-select-all-btn">Select All Visible</button>
            <button type="button" id="qa-fix-selected-btn" class="process-btn" disabled>Fix Selected</button>
            <button type="button" id="qa-fix-all-btn" class="secondary-btn" disabled>Fix All Mismatches</button>
            <span class="selection-info">Selected: <strong id="qa-selected-count">0</strong></span>
          </div>

          <!-- Results Table -->
          <div class="qa-results-table-container">
            <table class="qa-results-table">
              <thead>
                <tr>
                  <th class="th-checkbox"><label class="sr-only" for="qa-select-all-checkbox">Select all</label><input type="checkbox" id="qa-select-all-checkbox" title="Select all"></th>
                  <th class="th-poster">Poster</th>
                  <th class="th-field">Field</th>
                  <th class="th-current">Current Value</th>
                  <th class="th-suggested">Suggested Value</th>
                  <th class="th-confidence">Confidence</th>
                  <th class="th-status">Status</th>
                  <th class="th-actions">Actions</th>
                </tr>
              </thead>
              <tbody id="qa-results-tbody">
                <!-- Validation results rendered here -->
              </tbody>
            </table>
          </div>

          <!-- Results Pagination -->
          <div class="qa-results-pagination">
            <button type="button" id="qa-results-prev-btn" disabled>Previous</button>
            <span id="qa-results-page-info">Page 1</span>
            <button type="button" id="qa-results-next-btn" disabled>Next</button>
          </div>
        </section>

        <!-- Top Issues Section -->
        <section id="qa-issues-section" class="processing-section qa-issues-section hidden">
          <h2><span class="icon">‚ö†Ô∏è</span> Top Issues</h2>
          <div id="qa-top-issues" class="qa-issues-list">
            <!-- Top issues will be rendered here -->
          </div>
        </section>
      </div><!-- End QA Validation Tab -->

      <!-- Preview Modal -->
      <div id="preview-modal" class="modal hidden">
        <div class="modal-content preview-modal-content">
          <button type="button" class="modal-close" id="preview-modal-close">&times;</button>
          <div class="preview-layout">
            <div class="preview-image-container">
              <img id="preview-image" src="" alt="Preview">
            </div>
            <div class="preview-results">
              <h3>Extraction Results</h3>
              <div id="preview-loading" class="preview-loading hidden">
                <div class="spinner"></div>
                <p>Processing image with vision model...</p>
              </div>
              <div id="preview-data" class="preview-data hidden">
                <!-- Extracted data fields will be rendered here -->
              </div>
              <div id="preview-error" class="preview-error hidden">
                <div class="error-icon">‚ö†Ô∏è</div>
                <p id="preview-error-message">Error message</p>
              </div>
            </div>
          </div>
          <div class="preview-actions">
            <span class="preview-info">Processing time: <strong id="preview-time">--</strong>ms | Model: <strong id="preview-model">--</strong></span>
            <div class="preview-buttons">
              <button type="button" id="preview-commit-btn" class="process-btn" disabled>Commit to Database</button>
              <button type="button" id="preview-close-btn" class="secondary-btn">Close</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <footer>
      <p>Poster Memento - Knowledge Graph Powered Poster Management</p>
    </footer>
  </div>

  <script type="module" src="js/app.js"></script>
  <script type="module" src="js/processing.js"></script>
  <script type="module" src="js/qa-validation.js"></script>
</body>
</html>
