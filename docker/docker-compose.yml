services:
  # Vision Model: Using native Ollama on host (port 11434)
  # To use Docker Ollama instead, uncomment below and change port
  # ollama:
  #   image: ollama/ollama:latest
  #   container_name: poster-ollama
  #   ports:
  #     - "11435:11434"
  #   volumes:
  #     - ../data/ollama:/root/.ollama
  #   networks:
  #     - poster-network

  # S3-Compatible Image Storage
  minio:
    image: minio/minio:latest
    container_name: poster-minio
    ports:
      - "9000:9000"
      - "9001:9001"
    environment:
      - MINIO_ROOT_USER=minioadmin
      - MINIO_ROOT_PASSWORD=${MINIO_PASSWORD:-poster-memento-minio}
    volumes:
      - ../data/minio:/data
    command: server /data --console-address ":9001"
    networks:
      - poster-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Graph Database
  neo4j:
    image: neo4j:5.15.0
    container_name: poster-neo4j
    ports:
      - "7476:7474"
      - "7689:7687"
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-poster-memento-neo4j}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
    volumes:
      - ../data/neo4j/data:/data
      - ../data/neo4j/logs:/logs
    networks:
      - poster-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7474"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Vector Database
  postgres:
    image: pgvector/pgvector:pg16
    container_name: poster-postgres
    ports:
      - "5435:5432"
    environment:
      - POSTGRES_USER=memento
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-poster-memento-postgres}
      - POSTGRES_DB=memento_vectors
    volumes:
      - ../data/postgres:/var/lib/postgresql/data
    networks:
      - poster-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U memento"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Local Embeddings Service (disabled - TEI not available for ARM64)
  # Use Ollama's embedding models instead, or enable when x86 available
  # embeddings:
  #   image: ghcr.io/huggingface/text-embeddings-inference:cpu-1.5
  #   container_name: poster-embeddings
  #   ports:
  #     - "8080:80"
  #   environment:
  #     - MODEL_ID=sentence-transformers/all-mpnet-base-v2
  #   volumes:
  #     - ../data/embeddings-cache:/data
  #   networks:
  #     - poster-network

  # MinIO Bucket Initialization
  minio-init:
    image: minio/mc:latest
    container_name: poster-minio-init
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 minioadmin ${MINIO_PASSWORD:-poster-memento-minio};
      mc mb myminio/poster-images --ignore-existing;
      mc anonymous set download myminio/poster-images;
      echo 'Bucket poster-images created successfully';
      "
    networks:
      - poster-network

networks:
  poster-network:
    driver: bridge
